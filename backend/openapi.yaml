openapi: 3.0.3
info:
  title: Vantis Protocol API
  description: |
    Backend API for the Vantis "Buy & Keep" Card application.

    This API provides interfaces to interact with the Vantis smart contracts deployed on Stellar/Soroban:
    - **Oracle Adapter**: Price feeds and volatility data (Blend Protocol compatible - 14-decimal format)
    - **Blend Adapter**: Integration layer for Blend Protocol lending pools
    - **Vantis Pool**: Collateral deposits, borrowing, and lending (routes through Blend adapter)
    - **Risk Engine**: Risk management, stop-loss, and liquidations (uses Blend adapter for position queries)
    - **Borrow Limit Policy**: Smart account policy enforcement
    - **Smart Accounts**: OpenZeppelin Smart Account management with signers, rules, and policies

    ## Blend Protocol Integration

    The protocol is fully integrated with Blend Protocol for lending operations:

    ### Blend Adapter
    The Blend Adapter contract provides a simplified interface to Blend Protocol:
    - **Collateral Operations**: Deposit/withdraw collateral into Blend pools
    - **Borrow Operations**: Borrow USDC / repay loans via Blend
    - **Position Queries**: Get user positions and health factors
    - **Multi-Operation Submit**: Execute multiple operations atomically

    ### Oracle Compatibility
    All prices are provided in **14-decimal format** (Blend standard):
    - Price feeds are validated for staleness to ensure freshness
    - Volatility data supports Blend's risk calculations
    - Safe borrow calculations use Blend-compatible formulas

    ### Risk Engine Integration
    The Risk Engine queries the Blend adapter for position data to:
    - Calculate volatility-adjusted borrowing limits
    - Monitor health factors for stop-loss triggers
    - Execute partial liquidations when needed
  version: 1.0.0
  contact:
    name: Vantis Team
  license:
    name: MIT

servers:
  - url: https://api.vantis.io/v1
    description: Production server
  - url: https://api-testnet.vantis.io/v1
    description: Testnet server
  - url: http://localhost:3000/v1
    description: Local development

tags:
  - name: Oracle
    description: |
      Price feeds and volatility data from Reflector Oracle.

      **Blend Protocol Compatibility**: All prices are provided in 14-decimal format as required by Blend Protocol.
      This ensures seamless integration with Blend's oracle interface and risk calculations.
  - name: Pool
    description: Collateral deposits, borrowing, and lending operations
  - name: Blend
    description: |
      Blend Protocol adapter for lending operations.

      This adapter provides integration between Vantis and Blend Protocol lending pools:
      - Deposit/withdraw collateral into Blend pools
      - Borrow/repay USDC from Blend pools
      - Query positions and health factors
      - Multi-operation atomic submissions

      All operations are routed through the Blend adapter contract for seamless Blend integration.
  - name: Risk
    description: Risk management, stop-loss, and liquidation operations
  - name: Policy
    description: Smart account policy management
  - name: SmartAccount
    description: OpenZeppelin Smart Account management - signers, rules, policies, and transaction execution
  - name: Admin
    description: Administrative operations

paths:
  # ============ Oracle Endpoints ============
  /oracle/prices/{asset}:
    get:
      tags: [Oracle]
      summary: Get current price for an asset
      description: |
        Returns the latest price data for the specified asset from the oracle.
        
        **Blend Protocol Compatibility**: Prices are returned in 14-decimal format as required by Blend Protocol.
        The price is validated for staleness (default 5 minutes) to ensure freshness for risk calculations.
        
        **Price Format Examples**:
        - $0.10 = "10000000000000" (1e13)
        - $1.00 = "100000000000000" (1e14)
        - $45,000 = "4500000000000000000" (4.5e18)
      operationId: getPrice
      parameters:
        - name: asset
          in: path
          required: true
          description: Asset symbol (e.g., XLM, BTC, USDC)
          schema:
            type: string
            example: XLM
      responses:
        '200':
          description: Price data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PriceData'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Asset not supported
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Price is stale
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags: [Oracle]
      summary: Update price for an asset
      description: |
        Updates the price for an asset. Typically called by keeper bots or oracle push mechanisms.
        
        **Blend Protocol Compatibility**: Prices must be provided in 14-decimal format.
        The oracle adapter validates and stores prices in the exact format required by Blend Protocol.
        
        **Price Format**: All prices must use 14 decimals (e.g., $0.10 = "10000000000000")
      operationId: updatePrice
      security:
        - bearerAuth: []
      parameters:
        - name: asset
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [price, signature]
              properties:
                price:
                  type: string
                  description: Price in USD with 14 decimals
                  example: "1234567890000000"
                signature:
                  type: string
                  description: Stellar transaction signature
      responses:
        '200':
          description: Price updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /oracle/assets:
    get:
      tags: [Oracle]
      summary: List supported assets
      description: Returns a list of all assets supported by the oracle
      operationId: getAssets
      responses:
        '200':
          description: List of supported assets
          content:
            application/json:
              schema:
                type: object
                properties:
                  assets:
                    type: array
                    items:
                      $ref: '#/components/schemas/AssetConfig'

    post:
      tags: [Oracle, Admin]
      summary: Add a supported asset
      description: Adds a new asset to the oracle. Admin only.
      operationId: addAsset
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssetConfig'
      responses:
        '201':
          description: Asset added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /oracle/volatility/{asset}:
    get:
      tags: [Oracle]
      summary: Get volatility data for an asset
      description: Returns historical volatility data used for risk calculations
      operationId: getVolatility
      parameters:
        - name: asset
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Volatility data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VolatilityData'
        '404':
          description: Asset not supported or insufficient price history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oracle/safe-borrow:
    post:
      tags: [Oracle]
      summary: Calculate safe borrow amount
      description: |
        Calculates the volatility-adjusted safe borrow amount using the formula:
        B_safe = V_collateral × (LTV_base - k × σ × √T)
        
        **Blend Protocol Compatibility**: This calculation is fully compatible with Blend's risk model.
        It uses 14-decimal price feeds and volatility data to ensure accurate risk-adjusted borrowing limits.
        
        **Parameters**:
        - V_collateral: Collateral value in USD (14 decimals)
        - LTV_base: Base Loan-to-Value ratio (basis points, e.g., 7500 = 75%)
        - k: Volatility sensitivity factor (basis points)
        - σ: 30-day historical volatility (basis points)
        - T: Time horizon in years
      operationId: calculateSafeBorrow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [asset, collateralValue, baseLtv]
              properties:
                asset:
                  type: string
                  description: Collateral asset symbol
                  example: XLM
                collateralValue:
                  type: string
                  description: Collateral value in USD (14 decimals)
                  example: "10000000000000000"
                baseLtv:
                  type: integer
                  description: Base LTV in basis points (e.g., 7500 = 75%)
                  example: 7500
                kFactor:
                  type: integer
                  description: Volatility sensitivity factor (optional, uses default)
                  example: 100
                timeHorizonDays:
                  type: integer
                  description: Time horizon for volatility adjustment (optional)
                  example: 30
      responses:
        '200':
          description: Safe borrow amount calculated
          content:
            application/json:
              schema:
                type: object
                properties:
                  safeBorrowAmount:
                    type: string
                    description: Safe borrow amount in USD (14 decimals)
                  adjustedLtv:
                    type: integer
                    description: Adjusted LTV in basis points
                  volatility30d:
                    type: integer
                    description: 30-day volatility used in calculation
        '400':
          $ref: '#/components/responses/BadRequest'

  # ============ Pool Endpoints ============
  /pool/collateral/deposit:
    post:
      tags: [Pool]
      summary: Deposit collateral
      description: Deposits collateral assets into the lending pool
      operationId: depositCollateral
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CollateralDepositRequest'
      responses:
        '200':
          description: Deposit successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /pool/collateral/withdraw:
    post:
      tags: [Pool]
      summary: Withdraw collateral
      description: Withdraws collateral from the pool (must maintain healthy position)
      operationId: withdrawCollateral
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CollateralWithdrawRequest'
      responses:
        '200':
          description: Withdrawal successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Invalid request or withdrawal would liquidate position
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /pool/collateral/{user}:
    get:
      tags: [Pool]
      summary: Get user's collateral positions
      description: Returns all collateral positions for a user
      operationId: getCollateral
      parameters:
        - name: user
          in: path
          required: true
          description: Stellar account address
          schema:
            type: string
      responses:
        '200':
          description: Collateral positions retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: string
                  positions:
                    type: array
                    items:
                      $ref: '#/components/schemas/CollateralPosition'
                  totalValueUsd:
                    type: string
                    description: Total collateral value in USD

  /pool/borrow:
    post:
      tags: [Pool]
      summary: Borrow USDC
      description: Borrows USDC against deposited collateral
      operationId: borrow
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BorrowRequest'
      responses:
        '200':
          description: Borrow successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Invalid amount or insufficient collateral
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '503':
          description: Insufficient pool liquidity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /pool/repay:
    post:
      tags: [Pool]
      summary: Repay borrowed USDC
      description: Repays borrowed USDC (interest first, then principal)
      operationId: repay
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RepayRequest'
      responses:
        '200':
          description: Repayment successful
          content:
            application/json:
              schema:
                type: object
                allOf:
                  - $ref: '#/components/schemas/TransactionResult'
                  - type: object
                    properties:
                      amountRepaid:
                        type: string
                      remainingDebt:
                        type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: No borrow position exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /pool/supply:
    post:
      tags: [Pool]
      summary: Supply USDC liquidity
      description: Supplies USDC to the pool for lending
      operationId: supplyLiquidity
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [amount, signature]
              properties:
                amount:
                  type: string
                  description: Amount of USDC to supply
                  example: "1000000000"
                signature:
                  type: string
      responses:
        '200':
          description: Supply successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /pool/borrow/{user}:
    get:
      tags: [Pool]
      summary: Get user's borrow position
      description: Returns the borrow position for a user
      operationId: getBorrowPosition
      parameters:
        - name: user
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Borrow position retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BorrowPosition'

  /pool/health-factor/{user}:
    get:
      tags: [Pool]
      summary: Get user's health factor
      description: Returns the health factor for a user's position (10000 = 1.0)
      operationId: getHealthFactor
      parameters:
        - name: user
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Health factor retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: string
                  healthFactor:
                    type: string
                    description: Health factor (10000 = 1.0, higher is safer)
                  status:
                    type: string
                    enum: [healthy, warning, critical, liquidatable]

  /pool/reserves:
    get:
      tags: [Pool]
      summary: Get pool reserves
      description: Returns the current USDC reserves available for borrowing
      operationId: getReserves
      responses:
        '200':
          description: Pool reserves retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  reserves:
                    type: string
                    description: Available USDC reserves
                  totalBorrows:
                    type: string
                    description: Total outstanding borrows
                  utilization:
                    type: number
                    format: float
                    description: Pool utilization rate (0-1)

  /pool/interest-rate:
    get:
      tags: [Pool]
      summary: Get current interest rate
      description: Returns the current borrow interest rate based on utilization
      operationId: getInterestRate
      responses:
        '200':
          description: Interest rate retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  rate:
                    type: integer
                    description: Annual interest rate in basis points
                  utilization:
                    type: number
                    format: float
                  baseRate:
                    type: integer
                  slope1:
                    type: integer
                  slope2:
                    type: integer
                  optimalUtilization:
                    type: integer

  /pool/collateral-assets:
    get:
      tags: [Pool]
      summary: List supported collateral assets
      description: Returns all assets that can be used as collateral
      operationId: getCollateralAssets
      responses:
        '200':
          description: Collateral assets retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  assets:
                    type: array
                    items:
                      $ref: '#/components/schemas/CollateralConfig'

    post:
      tags: [Pool, Admin]
      summary: Add collateral asset
      description: Adds a new collateral asset to the pool. Admin only.
      operationId: addCollateralAsset
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CollateralConfig'
      responses:
        '201':
          description: Collateral asset added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /pool/blend-pool:
    get:
      tags: [Pool]
      summary: Get Blend pool address
      description: Returns the Blend adapter contract address used by the pool
      operationId: getPoolBlendPool
      responses:
        '200':
          description: Blend pool address retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  blendPool:
                    type: string
                    description: Blend adapter contract address

    put:
      tags: [Pool, Admin]
      summary: Set Blend pool address
      description: Updates the Blend adapter contract address. Admin only.
      operationId: setPoolBlendPool
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [blendPool]
              properties:
                blendPool:
                  type: string
                  description: Blend adapter contract address
      responses:
        '200':
          description: Blend pool address updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============ Blend Adapter Endpoints ============
  /blend/deposit:
    post:
      tags: [Blend]
      summary: Deposit collateral into Blend pool
      description: |
        Deposits collateral assets into the Blend Protocol lending pool.
        The adapter handles token transfers and approval to the Blend pool.
      operationId: blendDepositCollateral
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BlendDepositRequest'
      responses:
        '200':
          description: Deposit successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Invalid amount or asset not supported
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /blend/withdraw:
    post:
      tags: [Blend]
      summary: Withdraw collateral from Blend pool
      description: Withdraws collateral from the Blend Protocol lending pool
      operationId: blendWithdrawCollateral
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BlendWithdrawRequest'
      responses:
        '200':
          description: Withdrawal successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Invalid amount or would make position unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /blend/borrow:
    post:
      tags: [Blend]
      summary: Borrow USDC from Blend pool
      description: Borrows USDC from the Blend Protocol lending pool against deposited collateral
      operationId: blendBorrow
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BlendBorrowRequest'
      responses:
        '200':
          description: Borrow successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Invalid amount or insufficient collateral
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /blend/repay:
    post:
      tags: [Blend]
      summary: Repay borrowed USDC to Blend pool
      description: Repays borrowed USDC to the Blend Protocol lending pool
      operationId: blendRepay
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BlendRepayRequest'
      responses:
        '200':
          description: Repayment successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /blend/submit:
    post:
      tags: [Blend]
      summary: Submit multiple operations atomically
      description: |
        Submits multiple operations to the Blend pool in a single atomic transaction.
        Useful for complex operations like:
        - Deposit collateral + Borrow in one transaction
        - Repay + Withdraw collateral atomically
      operationId: blendSubmit
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [requests, signature]
              properties:
                requests:
                  type: array
                  items:
                    $ref: '#/components/schemas/BlendRequest'
                  description: Array of operations to perform
                signature:
                  type: string
      responses:
        '200':
          description: Operations submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /blend/positions/{user}:
    get:
      tags: [Blend]
      summary: Get user's Blend positions
      description: Returns user's collateral, liability, and supply positions in the Blend pool
      operationId: blendGetPositions
      parameters:
        - name: user
          in: path
          required: true
          description: User's Stellar address
          schema:
            type: string
      responses:
        '200':
          description: Positions retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlendPositions'
        '404':
          description: User has no positions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /blend/health-factor/{user}:
    get:
      tags: [Blend]
      summary: Get user's health factor from Blend
      description: |
        Calculates and returns the health factor for a user's position in the Blend pool.
        Health factor = (weighted collateral value) / (liability value)
        A health factor below 1.0 (10000 basis points) indicates the position is liquidatable.
      operationId: blendGetHealthFactor
      parameters:
        - name: user
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Health factor calculated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlendHealthFactorResult'

  /blend/pool-config:
    get:
      tags: [Blend]
      summary: Get Blend pool configuration
      description: Returns the configuration of the connected Blend pool
      operationId: blendGetPoolConfig
      responses:
        '200':
          description: Pool configuration retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlendPoolConfig'

  /blend/reserve/{asset}:
    get:
      tags: [Blend]
      summary: Get reserve data for an asset
      description: Returns the current reserve data for a specific asset in the Blend pool
      operationId: blendGetReserve
      parameters:
        - name: asset
          in: path
          required: true
          description: Asset token address
          schema:
            type: string
      responses:
        '200':
          description: Reserve data retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlendReserveData'
        '404':
          description: Asset not found in pool
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /blend/reserves:
    get:
      tags: [Blend]
      summary: List all reserves in Blend pool
      description: Returns list of all reserve addresses in the Blend pool
      operationId: blendGetReserveList
      responses:
        '200':
          description: Reserve list retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  reserves:
                    type: array
                    items:
                      type: string
                      description: Reserve asset address

  # ============ Risk Engine Endpoints ============
  /risk/safe-borrow:
    post:
      tags: [Risk]
      summary: Calculate volatility-adjusted safe borrow
      description: Uses the risk engine to calculate safe borrow with volatility adjustment
      operationId: calculateRiskAdjustedBorrow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [asset, collateralValue, baseLtv]
              properties:
                asset:
                  type: string
                collateralValue:
                  type: string
                baseLtv:
                  type: integer
      responses:
        '200':
          description: Safe borrow amount calculated
          content:
            application/json:
              schema:
                type: object
                properties:
                  safeBorrowAmount:
                    type: string
                  adjustedLtv:
                    type: integer
                  riskLevel:
                    type: string
                    enum: [low, medium, high]

  /risk/position-health/{user}:
    get:
      tags: [Risk]
      summary: Check position health status
      description: Returns detailed health status including risk level
      operationId: checkPositionHealth
      parameters:
        - name: user
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Position health retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: string
                  healthFactor:
                    type: string
                  status:
                    type: string
                    enum: [healthy, warning, critical, liquidatable]
                  stopLossEnabled:
                    type: boolean
                  recommendedAction:
                    type: string

  /risk/stop-loss/enable:
    post:
      tags: [Risk]
      summary: Enable stop-loss for user
      description: Enables automated stop-loss protection for a user's position
      operationId: enableStopLoss
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StopLossEnableRequest'
      responses:
        '200':
          description: Stop-loss enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /risk/stop-loss/disable:
    post:
      tags: [Risk]
      summary: Disable stop-loss
      description: Disables stop-loss for a user's position
      operationId: disableStopLoss
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [signature]
              properties:
                signature:
                  type: string
      responses:
        '200':
          description: Stop-loss disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /risk/stop-loss/trigger:
    post:
      tags: [Risk]
      summary: Trigger stop-loss execution
      description: Triggers stop-loss for a user when conditions are met
      operationId: triggerStopLoss
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user, signature]
              properties:
                user:
                  type: string
                  description: User address to trigger stop-loss for
                signature:
                  type: string
      responses:
        '200':
          description: Stop-loss triggered
          content:
            application/json:
              schema:
                type: object
                allOf:
                  - $ref: '#/components/schemas/TransactionResult'
                  - type: object
                    properties:
                      swapAmount:
                        type: string
                        description: Amount swapped to restore health
        '400':
          description: Position is healthy or stop-loss not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /risk/stop-loss/{user}:
    get:
      tags: [Risk]
      summary: Get stop-loss configuration
      description: Returns the stop-loss configuration for a user
      operationId: getStopLossConfig
      parameters:
        - name: user
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Stop-loss config retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserStopLossConfig'
        '404':
          description: Stop-loss not configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /risk/liquidate:
    post:
      tags: [Risk]
      summary: Execute partial liquidation
      description: Executes partial liquidation on an unhealthy position
      operationId: liquidate
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LiquidationRequest'
      responses:
        '200':
          description: Liquidation executed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LiquidationEvent'
        '400':
          description: Position is not liquidatable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /risk/params:
    get:
      tags: [Risk]
      summary: Get risk parameters
      description: Returns the current global risk parameters
      operationId: getRiskParams
      responses:
        '200':
          description: Risk parameters retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskParameters'

    put:
      tags: [Risk, Admin]
      summary: Update risk parameters
      description: Updates global risk parameters. Admin only.
      operationId: updateRiskParams
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RiskParameters'
      responses:
        '200':
          description: Risk parameters updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /risk/liquidators:
    get:
      tags: [Risk, Admin]
      summary: Get whitelisted liquidators
      description: Returns list of whitelisted liquidator addresses
      operationId: getLiquidators
      responses:
        '200':
          description: Liquidators retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  liquidators:
                    type: array
                    items:
                      type: string

    post:
      tags: [Risk, Admin]
      summary: Add liquidator to whitelist
      description: Adds a new liquidator to the whitelist. Admin only.
      operationId: addLiquidator
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [liquidator]
              properties:
                liquidator:
                  type: string
                  description: Liquidator address to whitelist
      responses:
        '200':
          description: Liquidator added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /risk/blend-adapter:
    get:
      tags: [Risk]
      summary: Get Blend adapter address
      description: Returns the Blend adapter contract address used by the risk engine
      operationId: getRiskBlendAdapter
      responses:
        '200':
          description: Blend adapter address retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  blendAdapter:
                    type: string
                    description: Blend adapter contract address

    put:
      tags: [Risk, Admin]
      summary: Set Blend adapter address
      description: Updates the Blend adapter contract address. Admin only.
      operationId: setRiskBlendAdapter
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [blendAdapter]
              properties:
                blendAdapter:
                  type: string
                  description: Blend adapter contract address
      responses:
        '200':
          description: Blend adapter address updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============ Policy Endpoints ============
  /policy/borrow-limit/install:
    post:
      tags: [Policy]
      summary: Install borrow limit policy
      description: Installs the borrow limit policy for a smart account
      operationId: installBorrowLimitPolicy
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PolicyInstallRequest'
      responses:
        '200':
          description: Policy installed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /policy/borrow-limit/uninstall:
    post:
      tags: [Policy]
      summary: Uninstall borrow limit policy
      description: Removes the borrow limit policy from a smart account
      operationId: uninstallBorrowLimitPolicy
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [account, ruleId, signature]
              properties:
                account:
                  type: string
                ruleId:
                  type: string
                  format: hex
                  description: 32-byte rule ID
                signature:
                  type: string
      responses:
        '200':
          description: Policy uninstalled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /policy/borrow-limit/config/{account}/{ruleId}:
    get:
      tags: [Policy]
      summary: Get policy configuration
      description: Returns the borrow limit policy configuration
      operationId: getPolicyConfig
      parameters:
        - name: account
          in: path
          required: true
          schema:
            type: string
        - name: ruleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Policy config retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BorrowLimitConfig'
        '404':
          description: Policy not installed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /policy/borrow-limit/usage/{account}/{ruleId}:
    get:
      tags: [Policy]
      summary: Get policy usage
      description: Returns current usage tracking for the policy
      operationId: getPolicyUsage
      parameters:
        - name: account
          in: path
          required: true
          schema:
            type: string
        - name: ruleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Policy usage retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BorrowUsage'
        '404':
          description: Policy not installed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /policy/borrow-limit/remaining-capacity/{account}/{ruleId}:
    get:
      tags: [Policy]
      summary: Get remaining borrow capacity
      description: Returns the remaining borrow capacity for the policy
      operationId: getRemainingCapacity
      parameters:
        - name: account
          in: path
          required: true
          schema:
            type: string
        - name: ruleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Remaining capacity retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  remainingCapacity:
                    type: string
                    description: Remaining borrow capacity
                  maxPerTx:
                    type: string
                  maxCumulative:
                    type: string
                  currentUsage:
                    type: string
        '404':
          description: Policy not installed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============ Smart Account Endpoints ============
  /accounts:
    post:
      tags: [SmartAccount]
      summary: Create a new smart account
      description: |
        Deploys a new OpenZeppelin Smart Account on Stellar/Soroban.
        The account is initialized with the provided signers and threshold.
      operationId: createSmartAccount
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSmartAccountRequest'
      responses:
        '201':
          description: Smart account created
          content:
            application/json:
              schema:
                type: object
                allOf:
                  - $ref: '#/components/schemas/TransactionResult'
                  - type: object
                    properties:
                      accountAddress:
                        type: string
                        description: Address of the newly created smart account
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /accounts/{address}:
    get:
      tags: [SmartAccount]
      summary: Get smart account details
      description: Returns full details of a smart account including signers, rules, and attached policies
      operationId: getSmartAccount
      parameters:
        - name: address
          in: path
          required: true
          description: Smart account address
          schema:
            type: string
      responses:
        '200':
          description: Smart account details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SmartAccount'
        '404':
          description: Smart account not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /accounts/{address}/signers:
    get:
      tags: [SmartAccount]
      summary: Get account signers
      description: Returns list of signers/owners for the smart account
      operationId: getAccountSigners
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Signers retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  signers:
                    type: array
                    items:
                      $ref: '#/components/schemas/Signer'
                  threshold:
                    type: integer
                    description: Required signatures threshold

    post:
      tags: [SmartAccount]
      summary: Add a signer
      description: Adds a new signer to the smart account
      operationId: addSigner
      security:
        - bearerAuth: []
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddSignerRequest'
      responses:
        '200':
          description: Signer added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /accounts/{address}/signers/{signer}:
    delete:
      tags: [SmartAccount]
      summary: Remove a signer
      description: Removes a signer from the smart account
      operationId: removeSigner
      security:
        - bearerAuth: []
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
        - name: signer
          in: path
          required: true
          description: Signer address to remove
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [signature]
              properties:
                signature:
                  type: string
      responses:
        '200':
          description: Signer removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Cannot remove signer (would break threshold)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /accounts/{address}/threshold:
    put:
      tags: [SmartAccount]
      summary: Update signature threshold
      description: Updates the required signature threshold for the smart account
      operationId: updateThreshold
      security:
        - bearerAuth: []
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [threshold, signature]
              properties:
                threshold:
                  type: integer
                  minimum: 1
                  description: New signature threshold
                signature:
                  type: string
      responses:
        '200':
          description: Threshold updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Invalid threshold (exceeds signer count)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /accounts/{address}/rules:
    get:
      tags: [SmartAccount]
      summary: List context rules
      description: Returns all context rules configured for the smart account
      operationId: getContextRules
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Context rules retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  rules:
                    type: array
                    items:
                      $ref: '#/components/schemas/ContextRule'

    post:
      tags: [SmartAccount]
      summary: Create a context rule
      description: |
        Creates a new context rule for the smart account.
        Context rules define which contracts/functions can be called and what policies apply.
      operationId: createContextRule
      security:
        - bearerAuth: []
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateContextRuleRequest'
      responses:
        '201':
          description: Context rule created
          content:
            application/json:
              schema:
                type: object
                allOf:
                  - $ref: '#/components/schemas/TransactionResult'
                  - type: object
                    properties:
                      ruleId:
                        type: string
                        description: ID of the created rule (32 bytes hex)
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /accounts/{address}/rules/{ruleId}:
    get:
      tags: [SmartAccount]
      summary: Get context rule details
      description: Returns details of a specific context rule
      operationId: getContextRule
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
        - name: ruleId
          in: path
          required: true
          description: Rule ID (32 bytes hex)
          schema:
            type: string
      responses:
        '200':
          description: Context rule retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContextRule'
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [SmartAccount]
      summary: Update context rule
      description: Updates an existing context rule
      operationId: updateContextRule
      security:
        - bearerAuth: []
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
        - name: ruleId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateContextRuleRequest'
      responses:
        '200':
          description: Context rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags: [SmartAccount]
      summary: Delete context rule
      description: Deletes a context rule from the smart account
      operationId: deleteContextRule
      security:
        - bearerAuth: []
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
        - name: ruleId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [signature]
              properties:
                signature:
                  type: string
      responses:
        '200':
          description: Context rule deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /accounts/{address}/rules/{ruleId}/policies:
    get:
      tags: [SmartAccount]
      summary: List attached policies
      description: Returns all policies attached to a context rule
      operationId: getRulePolicies
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
        - name: ruleId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Policies retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  policies:
                    type: array
                    items:
                      $ref: '#/components/schemas/AttachedPolicy'

    post:
      tags: [SmartAccount]
      summary: Attach a policy
      description: Attaches a policy contract to a context rule
      operationId: attachPolicy
      security:
        - bearerAuth: []
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
        - name: ruleId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AttachPolicyRequest'
      responses:
        '200':
          description: Policy attached
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /accounts/{address}/rules/{ruleId}/policies/{policyAddress}:
    delete:
      tags: [SmartAccount]
      summary: Detach a policy
      description: Detaches a policy from a context rule
      operationId: detachPolicy
      security:
        - bearerAuth: []
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
        - name: ruleId
          in: path
          required: true
          schema:
            type: string
        - name: policyAddress
          in: path
          required: true
          description: Policy contract address to detach
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [signature]
              properties:
                signature:
                  type: string
      responses:
        '200':
          description: Policy detached
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Policy not attached
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /accounts/{address}/execute:
    post:
      tags: [SmartAccount]
      summary: Execute transaction
      description: |
        Executes a transaction through the smart account.
        The transaction is validated against context rules and policies before execution.
      operationId: executeTransaction
      security:
        - bearerAuth: []
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteTransactionRequest'
      responses:
        '200':
          description: Transaction executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteTransactionResult'
        '400':
          description: Transaction rejected by policy or invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Policy enforcement failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyEnforcementError'

  /accounts/{address}/simulate:
    post:
      tags: [SmartAccount]
      summary: Simulate transaction
      description: |
        Simulates a transaction without executing it.
        Useful for checking if a transaction would pass policy checks.
      operationId: simulateTransaction
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SimulateTransactionRequest'
      responses:
        '200':
          description: Simulation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationResult'
        '400':
          $ref: '#/components/responses/BadRequest'

  /accounts/{address}/nonce:
    get:
      tags: [SmartAccount]
      summary: Get account nonce
      description: Returns the current nonce for the smart account (used for transaction ordering)
      operationId: getAccountNonce
      parameters:
        - name: address
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Nonce retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  nonce:
                    type: integer
                    format: int64

  # ============ Admin Endpoints ============
  /admin/initialize/oracle:
    post:
      tags: [Admin]
      summary: Initialize oracle adapter contract
      description: Initializes the oracle adapter contract. One-time operation.
      operationId: initializeOracle
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [admin, oracleContract]
              properties:
                admin:
                  type: string
                oracleContract:
                  type: string
                  description: Reflector oracle contract address
      responses:
        '200':
          description: Oracle initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Already initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/initialize/pool:
    post:
      tags: [Admin]
      summary: Initialize pool contract
      description: Initializes the Vantis pool contract. One-time operation.
      operationId: initializePool
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [admin, oracle, usdcToken, blendPoolAddress, interestParams]
              properties:
                admin:
                  type: string
                oracle:
                  type: string
                usdcToken:
                  type: string
                blendPoolAddress:
                  type: string
                  description: Blend adapter contract address for lending operations
                interestParams:
                  $ref: '#/components/schemas/InterestRateParams'
      responses:
        '200':
          description: Pool initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Already initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/initialize/blend-adapter:
    post:
      tags: [Admin]
      summary: Initialize Blend adapter contract
      description: Initializes the Blend adapter contract for Blend Protocol integration. One-time operation.
      operationId: initializeBlendAdapter
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [admin, blendPool, oracle, usdcToken]
              properties:
                admin:
                  type: string
                  description: Admin address for the adapter
                blendPool:
                  type: string
                  description: Blend Protocol pool contract address
                oracle:
                  type: string
                  description: Oracle contract for price feeds
                usdcToken:
                  type: string
                  description: USDC token address for borrowing
      responses:
        '200':
          description: Blend adapter initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Already initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/blend/register-asset:
    post:
      tags: [Admin, Blend]
      summary: Register a collateral asset in Blend adapter
      description: Registers an asset as supported collateral in the Blend adapter. Admin only.
      operationId: blendRegisterAsset
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [asset, reserveIndex]
              properties:
                asset:
                  type: string
                  description: Asset token contract address
                reserveIndex:
                  type: integer
                  description: Index of the asset in the Blend pool
      responses:
        '200':
          description: Asset registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/initialize/risk-engine:
    post:
      tags: [Admin]
      summary: Initialize risk engine contract
      description: Initializes the risk engine contract. One-time operation.
      operationId: initializeRiskEngine
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [admin, oracle, pool, usdcToken, blendAdapter, params]
              properties:
                admin:
                  type: string
                oracle:
                  type: string
                pool:
                  type: string
                usdcToken:
                  type: string
                blendAdapter:
                  type: string
                  description: Blend adapter contract address for position queries
                params:
                  $ref: '#/components/schemas/RiskParameters'
      responses:
        '200':
          description: Risk engine initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '400':
          description: Already initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/set-swap-router:
    post:
      tags: [Admin]
      summary: Set swap router for stop-loss
      description: Sets the DEX router address for stop-loss swaps
      operationId: setSwapRouter
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [router]
              properties:
                router:
                  type: string
                  description: DEX/swap router contract address
      responses:
        '200':
          description: Swap router set
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/set-treasury:
    post:
      tags: [Admin]
      summary: Set treasury address
      description: Sets the protocol treasury address for fees
      operationId: setTreasury
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [treasury]
              properties:
                treasury:
                  type: string
                  description: Treasury address
      responses:
        '200':
          description: Treasury set
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/set-risk-engine:
    post:
      tags: [Admin]
      summary: Set risk engine in pool
      description: Links the risk engine contract to the pool
      operationId: setRiskEngine
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [riskEngine]
              properties:
                riskEngine:
                  type: string
                  description: Risk engine contract address
      responses:
        '200':
          description: Risk engine set
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token or Stellar signed authentication

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Authentication required or not authorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    # ============ Oracle Schemas ============
    PriceData:
      type: object
      description: |
        Price data in Blend Protocol compatible format.
        
        **Format**: All prices use 14 decimal places as required by Blend Protocol.
        
        **Examples**:
        - $0.01 USD = "1000000000000" (1e12)
        - $0.10 USD = "10000000000000" (1e13)
        - $1.00 USD = "100000000000000" (1e14)
        - $10.00 USD = "1000000000000000" (1e15)
        - $45,000.00 USD = "4500000000000000000" (4.5e18)
      properties:
        price:
          type: string
          description: Price in USD with 14 decimals (Blend Protocol standard)
          example: "100000000000000"
        timestamp:
          type: integer
          format: int64
          description: Unix timestamp of price update
        source:
          type: string
          description: Source identifier (e.g., "reflector")
          example: reflector

    VolatilityData:
      type: object
      description: |
        Historical volatility data used for Blend-compatible risk calculations.
        
        Volatility is expressed in basis points (10000 = 100%) and is annualized.
        This data is used in the safe borrow calculation formula:
        B_safe = V_collateral × (LTV_base - k × σ × √T)
      properties:
        volatility30d:
          type: integer
          description: 30-day annualized volatility in basis points (e.g., 5000 = 50%)
          example: 5000
        volatility7d:
          type: integer
          description: 7-day annualized volatility in basis points
          example: 4500
        lastUpdated:
          type: integer
          format: int64
          description: Unix timestamp of last volatility update
        priceHistoryLength:
          type: integer
          description: Number of price points in history (max 30)
          example: 30

    AssetConfig:
      type: object
      required: [symbol, contract, decimals, baseLtv, liquidationThreshold]
      description: |
        Asset configuration for oracle price feeds.
        
        **Blend Compatibility**: Assets are configured with LTV parameters that work with
        Blend's risk model. Prices for these assets are always provided in 14-decimal format.
      properties:
        symbol:
          type: string
          description: Asset symbol (e.g., XLM, BTC, USDC)
          example: XLM
        contract:
          type: string
          description: Stellar asset contract address
          example: "CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABSC4"
        decimals:
          type: integer
          description: Asset native decimals (for conversion purposes)
          example: 7
        baseLtv:
          type: integer
          description: Base Loan-to-Value in basis points (e.g., 7500 = 75%)
          example: 7500
        liquidationThreshold:
          type: integer
          description: Liquidation threshold in basis points (e.g., 8500 = 85%)
          example: 8500

    # ============ Blend Adapter Schemas ============
    BlendRequest:
      type: object
      description: A single request to submit to a Blend pool
      required: [requestType, address, amount]
      properties:
        requestType:
          $ref: '#/components/schemas/BlendRequestType'
        address:
          type: string
          description: Asset address for this operation
        amount:
          type: string
          description: Amount for this operation (token amount with decimals)

    BlendRequestType:
      type: string
      description: |
        Type of Blend pool operation. Values must match Blend Protocol's RequestType enum:
        Supply=0, Withdraw=1, SupplyCollateral=2, WithdrawCollateral=3, Borrow=4, Repay=5, etc.
      enum:
        - Supply
        - Withdraw
        - SupplyCollateral
        - WithdrawCollateral
        - Borrow
        - Repay
        - FillUserLiquidationAuction
        - FillBadDebtAuction
        - FillInterestAuction
        - DeleteLiquidationAuction

    BlendDepositRequest:
      type: object
      required: [asset, amount, signature]
      properties:
        asset:
          type: string
          description: Collateral asset token address
        amount:
          type: string
          description: Amount to deposit
        signature:
          type: string
          description: Stellar transaction signature

    BlendWithdrawRequest:
      type: object
      required: [asset, amount, signature]
      properties:
        asset:
          type: string
          description: Collateral asset token address
        amount:
          type: string
          description: Amount to withdraw
        signature:
          type: string

    BlendBorrowRequest:
      type: object
      required: [amount, signature]
      properties:
        amount:
          type: string
          description: Amount of USDC to borrow
        signature:
          type: string

    BlendRepayRequest:
      type: object
      required: [amount, signature]
      properties:
        amount:
          type: string
          description: Amount of USDC to repay
        signature:
          type: string

    BlendPositions:
      type: object
      description: User's positions in the Blend pool
      properties:
        collateral:
          type: array
          description: Collateral positions (asset index, amount pairs)
          items:
            $ref: '#/components/schemas/BlendPositionEntry'
        liabilities:
          type: array
          description: Liability positions (borrows)
          items:
            $ref: '#/components/schemas/BlendPositionEntry'
        supply:
          type: array
          description: Supply positions (lending)
          items:
            $ref: '#/components/schemas/BlendPositionEntry'

    BlendPositionEntry:
      type: object
      description: A single position entry with asset index and amount
      properties:
        assetIndex:
          type: integer
          description: Index of the asset in the Blend pool
        amount:
          type: string
          description: Position amount

    BlendHealthFactorResult:
      type: object
      description: Health factor calculation result from Blend adapter
      properties:
        healthFactor:
          type: string
          description: Health factor in basis points (10000 = 1.0, >10000 = healthy)
        totalCollateral:
          type: string
          description: Total collateral value in base currency
        totalLiabilities:
          type: string
          description: Total liability value in base currency
        isLiquidatable:
          type: boolean
          description: Whether position is liquidatable (health factor < 10000)

    BlendPoolConfig:
      type: object
      description: Blend pool configuration
      properties:
        oracle:
          type: string
          description: Oracle contract address used by the pool
        bstopRate:
          type: integer
          description: Base fee for borrowing (basis points)
        status:
          type: integer
          description: Pool status (0 = active, 1 = on-ice, 2 = frozen)
        maxPositions:
          type: integer
          description: Maximum number of positions allowed per user

    BlendReserveConfig:
      type: object
      description: Reserve configuration for a Blend pool asset
      properties:
        index:
          type: integer
          description: Index of the reserve in the pool
        decimals:
          type: integer
          description: Number of decimals for the asset
        cFactor:
          type: integer
          description: Collateral factor (basis points, e.g., 7500 = 75%)
        lFactor:
          type: integer
          description: Liability factor (basis points)
        util:
          type: integer
          description: Utilization at which the interest rate model kinks
        maxUtil:
          type: integer
          description: Maximum utilization allowed
        rBase:
          type: integer
          description: Base interest rate (basis points per year)
        rOne:
          type: integer
          description: Interest rate slope below optimal utilization
        rTwo:
          type: integer
          description: Interest rate slope above optimal utilization
        rThree:
          type: integer
          description: Interest rate slope at max utilization
        reactivity:
          type: integer
          description: Reactivity parameter for interest rate updates

    BlendReserveData:
      type: object
      description: Reserve data for a Blend pool asset
      properties:
        bRate:
          type: string
          description: Current borrow rate (scaled)
        dRate:
          type: string
          description: Current supply rate (scaled)
        irMod:
          type: string
          description: Interest rate modifier
        bSupply:
          type: string
          description: Total bTokens (borrower tokens)
        dSupply:
          type: string
          description: Total dTokens (lender tokens)
        backstopCredit:
          type: string
          description: Backstop credit
        lastTime:
          type: integer
          format: int64
          description: Last update timestamp

    BlendAuctionData:
      type: object
      description: Auction data for liquidations
      properties:
        bid:
          type: string
          description: Bid amount
        lot:
          type: string
          description: Lot amount
        block:
          type: integer
          description: Block number when auction started

    # ============ Pool Schemas ============
    CollateralConfig:
      type: object
      required: [token, symbol, collateralFactor, liquidationThreshold, liquidationPenalty]
      properties:
        token:
          type: string
          description: Token contract address
        symbol:
          type: string
          description: Asset symbol for oracle lookup
        collateralFactor:
          type: integer
          description: Collateral factor in basis points
          example: 7500
        liquidationThreshold:
          type: integer
          description: Liquidation threshold in basis points
          example: 8500
        liquidationPenalty:
          type: integer
          description: Liquidation penalty in basis points
          example: 500
        isActive:
          type: boolean
          default: true

    CollateralPosition:
      type: object
      properties:
        asset:
          type: string
        amount:
          type: string
        valueUsd:
          type: string
        collateralFactor:
          type: integer

    CollateralDepositRequest:
      type: object
      required: [asset, amount, signature]
      properties:
        asset:
          type: string
          description: Collateral token contract address
        amount:
          type: string
          description: Amount to deposit
        signature:
          type: string
          description: Stellar transaction signature

    CollateralWithdrawRequest:
      type: object
      required: [asset, amount, signature]
      properties:
        asset:
          type: string
        amount:
          type: string
        signature:
          type: string

    BorrowRequest:
      type: object
      required: [amount, signature]
      properties:
        amount:
          type: string
          description: USDC amount to borrow
        signature:
          type: string

    RepayRequest:
      type: object
      required: [amount, signature]
      properties:
        amount:
          type: string
          description: USDC amount to repay
        signature:
          type: string

    BorrowPosition:
      type: object
      properties:
        user:
          type: string
        principal:
          type: string
          description: Principal borrowed
        accruedInterest:
          type: string
          description: Accrued interest
        totalDebt:
          type: string
          description: Total debt (principal + interest)
        lastAccrual:
          type: integer
          format: int64
        interestRate:
          type: integer
          description: Current interest rate in basis points

    InterestRateParams:
      type: object
      required: [baseRate, slope1, slope2, optimalUtilization]
      properties:
        baseRate:
          type: integer
          description: Base interest rate in basis points per year
          example: 200
        slope1:
          type: integer
          description: Rate slope below optimal utilization
          example: 400
        slope2:
          type: integer
          description: Rate slope above optimal utilization
          example: 7500
        optimalUtilization:
          type: integer
          description: Optimal utilization in basis points
          example: 8000

    # ============ Risk Engine Schemas ============
    RiskParameters:
      type: object
      properties:
        kFactor:
          type: integer
          description: Volatility sensitivity factor in basis points
          example: 100
        timeHorizonDays:
          type: integer
          description: Time horizon for volatility calculation
          example: 30
        stopLossThreshold:
          type: string
          description: Health factor threshold for stop-loss (basis points)
          example: "10200"
        liquidationThreshold:
          type: string
          description: Health factor threshold for liquidation
          example: "10000"
        targetHealthFactor:
          type: string
          description: Target health factor after liquidation
          example: "10500"
        liquidationPenalty:
          type: integer
          description: Liquidation penalty in basis points
          example: 500
        protocolFee:
          type: integer
          description: Protocol fee from liquidations in basis points
          example: 100
        minCollateralFactor:
          type: integer
          description: Minimum collateral factor floor
          example: 3000

    UserStopLossConfig:
      type: object
      properties:
        enabled:
          type: boolean
        customThreshold:
          type: string
          description: Custom threshold (0 = use global)
        swapPriority:
          type: array
          items:
            type: string
          description: Assets to swap in priority order
        maxSlippage:
          type: integer
          description: Maximum slippage in basis points
          example: 300

    StopLossEnableRequest:
      type: object
      required: [signature]
      properties:
        customThreshold:
          type: string
          description: Custom health factor threshold (optional)
        swapPriority:
          type: array
          items:
            type: string
          description: Asset addresses in swap priority order
        maxSlippage:
          type: integer
          description: Max slippage in basis points (max 1000)
          default: 300
        signature:
          type: string

    LiquidationRequest:
      type: object
      required: [user, collateralAsset, debtToRepay, signature]
      properties:
        user:
          type: string
          description: User address to liquidate
        collateralAsset:
          type: string
          description: Collateral asset to seize
        debtToRepay:
          type: string
          description: Amount of debt to repay
        signature:
          type: string

    LiquidationEvent:
      type: object
      properties:
        user:
          type: string
        liquidator:
          type: string
        collateralAsset:
          type: string
        collateralSeized:
          type: string
        debtRepaid:
          type: string
        penalty:
          type: string
        protocolFee:
          type: string
        timestamp:
          type: integer
          format: int64
        transactionHash:
          type: string

    # ============ Policy Schemas ============
    BorrowLimitConfig:
      type: object
      properties:
        maxPerTx:
          type: string
          description: Maximum borrow per transaction
        maxCumulative:
          type: string
          description: Maximum cumulative borrow in time window
        timeWindow:
          type: integer
          format: int64
          description: Time window in seconds
        poolContract:
          type: string
          description: Pool contract this policy applies to

    BorrowUsage:
      type: object
      properties:
        cumulativeBorrowed:
          type: string
          description: Cumulative borrowed in current window
        windowStart:
          type: integer
          format: int64
          description: Window start timestamp

    PolicyInstallRequest:
      type: object
      required: [account, ruleId, maxPerTx, maxCumulative, timeWindow, poolContract, signature]
      properties:
        account:
          type: string
          description: Smart account address
        ruleId:
          type: string
          format: hex
          description: 32-byte rule ID (hex encoded)
        maxPerTx:
          type: string
          description: Max borrow per transaction
        maxCumulative:
          type: string
          description: Max cumulative borrow in window
        timeWindow:
          type: integer
          description: Time window in seconds
        poolContract:
          type: string
          description: Pool contract address
        signature:
          type: string

    # ============ Smart Account Schemas ============
    SmartAccount:
      type: object
      properties:
        address:
          type: string
          description: Smart account contract address
        signers:
          type: array
          items:
            $ref: '#/components/schemas/Signer'
        threshold:
          type: integer
          description: Required signature threshold
        nonce:
          type: integer
          format: int64
          description: Current transaction nonce
        rules:
          type: array
          items:
            $ref: '#/components/schemas/ContextRule'
        createdAt:
          type: integer
          format: int64
          description: Account creation timestamp

    Signer:
      type: object
      properties:
        address:
          type: string
          description: Signer's Stellar address
        weight:
          type: integer
          description: Signer weight for threshold calculation
          default: 1
        addedAt:
          type: integer
          format: int64
          description: Timestamp when signer was added

    ContextRule:
      type: object
      properties:
        ruleId:
          type: string
          description: Rule ID (32 bytes hex encoded)
        name:
          type: string
          description: Human-readable rule name
        targetContracts:
          type: array
          items:
            type: string
          description: Contract addresses this rule applies to
        allowedFunctions:
          type: array
          items:
            type: string
          description: Function names allowed by this rule (empty = all)
        policies:
          type: array
          items:
            $ref: '#/components/schemas/AttachedPolicy'
        isActive:
          type: boolean
          default: true
        createdAt:
          type: integer
          format: int64

    AttachedPolicy:
      type: object
      properties:
        policyAddress:
          type: string
          description: Policy contract address
        policyType:
          type: string
          description: Type of policy (e.g., borrow-limit, spending-limit)
          example: borrow-limit
        params:
          type: object
          description: Policy-specific parameters
          additionalProperties: true
        attachedAt:
          type: integer
          format: int64

    CreateSmartAccountRequest:
      type: object
      required: [signers, threshold]
      properties:
        signers:
          type: array
          items:
            type: object
            required: [address]
            properties:
              address:
                type: string
              weight:
                type: integer
                default: 1
          minItems: 1
          description: Initial signers for the account
        threshold:
          type: integer
          minimum: 1
          description: Required signature threshold
        salt:
          type: string
          description: Optional salt for deterministic address generation

    AddSignerRequest:
      type: object
      required: [signer, signature]
      properties:
        signer:
          type: object
          required: [address]
          properties:
            address:
              type: string
            weight:
              type: integer
              default: 1
        newThreshold:
          type: integer
          description: Optionally update threshold when adding signer
        signature:
          type: string

    CreateContextRuleRequest:
      type: object
      required: [name, targetContracts, signature]
      properties:
        name:
          type: string
          description: Human-readable rule name
        targetContracts:
          type: array
          items:
            type: string
          description: Contract addresses this rule applies to
        allowedFunctions:
          type: array
          items:
            type: string
          description: Function names allowed (empty = all functions)
        signature:
          type: string

    UpdateContextRuleRequest:
      type: object
      required: [signature]
      properties:
        name:
          type: string
        targetContracts:
          type: array
          items:
            type: string
        allowedFunctions:
          type: array
          items:
            type: string
        isActive:
          type: boolean
        signature:
          type: string

    AttachPolicyRequest:
      type: object
      required: [policyAddress, signature]
      properties:
        policyAddress:
          type: string
          description: Policy contract address to attach
        policyType:
          type: string
          description: Type identifier for the policy
        params:
          type: object
          description: Policy-specific initialization parameters
          additionalProperties: true
        signature:
          type: string

    ExecuteTransactionRequest:
      type: object
      required: [calls, signatures]
      properties:
        calls:
          type: array
          items:
            $ref: '#/components/schemas/ContractCall'
          description: Contract calls to execute
        nonce:
          type: integer
          format: int64
          description: Transaction nonce (auto-filled if omitted)
        deadline:
          type: integer
          format: int64
          description: Transaction deadline timestamp
        signatures:
          type: array
          items:
            type: string
          description: Signatures from signers

    ContractCall:
      type: object
      required: [contract, function, args]
      properties:
        contract:
          type: string
          description: Target contract address
        function:
          type: string
          description: Function name to call
        args:
          type: array
          items:
            type: object
          description: Function arguments (Soroban values)

    ExecuteTransactionResult:
      type: object
      allOf:
        - $ref: '#/components/schemas/TransactionResult'
        - type: object
          properties:
            results:
              type: array
              items:
                type: object
                properties:
                  callIndex:
                    type: integer
                  success:
                    type: boolean
                  returnValue:
                    type: object
                  error:
                    type: string

    SimulateTransactionRequest:
      type: object
      required: [calls]
      properties:
        calls:
          type: array
          items:
            $ref: '#/components/schemas/ContractCall'
        signerAddresses:
          type: array
          items:
            type: string
          description: Addresses of signers for simulation

    SimulationResult:
      type: object
      properties:
        wouldSucceed:
          type: boolean
          description: Whether the transaction would succeed
        estimatedFee:
          type: string
          description: Estimated transaction fee
        policyChecks:
          type: array
          items:
            type: object
            properties:
              policy:
                type: string
              passed:
                type: boolean
              message:
                type: string
        results:
          type: array
          items:
            type: object
            properties:
              callIndex:
                type: integer
              success:
                type: boolean
              returnValue:
                type: object
              error:
                type: string
        resourceUsage:
          type: object
          properties:
            cpuInstructions:
              type: integer
            memoryBytes:
              type: integer
            storageReads:
              type: integer
            storageWrites:
              type: integer

    PolicyEnforcementError:
      type: object
      properties:
        code:
          type: string
          example: POLICY_VIOLATION
        message:
          type: string
        policyAddress:
          type: string
          description: Address of the policy that rejected the transaction
        policyType:
          type: string
          description: Type of policy that failed
        violationType:
          type: string
          enum: [EXCEEDS_LIMIT, UNAUTHORIZED_FUNCTION, RATE_LIMITED, CUSTOM]
        details:
          type: object
          description: Policy-specific error details

    # ============ Common Schemas ============
    TransactionResult:
      type: object
      properties:
        success:
          type: boolean
        transactionHash:
          type: string
          description: Stellar transaction hash
        ledger:
          type: integer
          description: Ledger sequence number
        timestamp:
          type: integer
          format: int64

    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          description: Error code
          example: INSUFFICIENT_COLLATERAL
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error details
